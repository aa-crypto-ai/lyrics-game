{% extends 'templates/room/base.html' %}

{% block title %}
    估歌詞
{% endblock %}

{% block header_text %}
    估歌詞
{% endblock %}

{% block style %}
<style>
    #container {
        margin: auto;
        width: 900px;
        height: 500px;
    }
    #text_container {
        position: relative;
        min-height: 460px;
        height: 80%;
    }
    #guess_container {
        position: relative;
        float: left;
        width: 200px;
        height: 500px;
    }
    #guess_entries {
        overflow-y:auto;
        max-height:100%;
        bottom: 0;
        left: 0;
    }
    #guess_box_container {
        position: absolute;
        bottom: 0;
        left: 0;
    }
    #lyrics_play {
        height: 500px;
        overflow-y: scroll;
    }
    .word {
        display: inline-block;
        width: 80px;
    }
    #input {
        width: 100px;
    }
    .hidden {
        color: gray;
    }
</style>
{% endblock %}

{% block content %}

    <div id='container'>
        <div id='guess_container'>
            <div id="text_container">
                <div id="guess_entries"></div>
            </div>
            <div id="guess_box_container">
                <input id="input" type="text"></input>
                <button onclick="sendText()">Send</button>
            </div>
            
        </div>
        <div id='lyrics_play'></div>
    </div>

{% endblock %}

{% block scripts %}
    {% load static %}
    <script src="{% static "js/vendor/jquery-3.2.1.min.js" %}"></script>
    <script>
        
        $(document).ready(function() {
            $('#input').keydown(function(event) {
                if (event.keyCode == 13) {
                    sendText();
                    return false;
                 }
            });
        });

        var username = '{{ user.username }}';
        var socket = new WebSocket("ws://" + window.location.host + "/{{ room.id }}/?username=" + username);

        var sendText = function(){
            var message = $('#input').val();
            $('#input').val('');
            socket.send(JSON.stringify({"command": "guess", "text": message}));
        }
        socket.onmessage = function(e) {
            var data = JSON.parse(e.data)
            if (data.command == 'guess'){
                $('<div>').html(data.username + ': ' + data.text).appendTo($('#guess_entries'));
            } else if(data.username == username && data.command == 'join'){
                for ( var i = 0; i < data.prev_entries.length ; ++i ) {
                    var prev_entry = data.prev_entries[i];
                    $('<div>').html(prev_entry.username + ': ' + prev_entry.text).appendTo($('#guess_entries'));
                }
            }
            $('#guess_entries').animate({scrollTop: $('#guess_entries').prop('scrollHeight')});

            $('#lyrics_play').html('');

            var lyrics_entries = data.guessed_lyrics;
            lyrics_entries.forEach(function(entry, idx){
                var div = $('<div>').html(entry).attr('id', 'entry_'+idx).addClass('word');
                if (entry == '???') div.addClass('hidden');
                div.appendTo('#lyrics_play')
            })

        }
        socket.onopen = function() {
            socket.send(
                JSON.stringify({"command": "join"})
            );
        }
        // Call onopen directly if socket is already open
        if (socket.readyState == WebSocket.OPEN) socket.onopen();
    </script>
{% endblock %}